#!/bin/bash
DB="$HOME/batch_tech/learning/db/index.db"
DL_DIR="$HOME/batch_tech/learning/downloads"

# Initialize DB if missing
sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS content (id TEXT PRIMARY KEY, title TEXT, channel TEXT, duration TEXT, url TEXT, type TEXT);"

# Function: Fetch & Index (Only runs if you type a query)
if [ ! -z "$1" ]; then
    echo "ðŸ” Fetching fresh data from YouTube for: $1..."
    # We strip tabs from titles to ensure database integrity
    yt-dlp "ytsearch20:$1" --dump-json --skip-download --flat-playlist 2>/dev/null | \
    jq -r '[.id, .title, .uploader, .duration_string, .webpage_url, ._type] | @tsv' | \
    while IFS=$'\t' read -r id title channel dur url type; do
        safe_title=$(echo "$title" | tr -d '\t' | sed "s/'/''/g")
        sqlite3 "$DB" "INSERT OR IGNORE INTO content VALUES ('$id', '$safe_title', '$channel', '$dur', '$url', '$type');"
    done
fi

# Function: FZF Interface (Instant Local Search)
# Using Tab as delimiter to handle titles with special chars like | or :
SELECTED=$(sqlite3 "$DB" -separator $'\t' "SELECT type, title, channel, duration, url FROM content ORDER BY rowid DESC;" | \
fzf --delimiter=$'\t' --with-nth=1,2,3,4 --prompt="ðŸŽ“ Select Course > " --border --height=50% --layout=reverse)

# Exit if nothing selected
[ -z "$SELECTED" ] && exit 0

# Extract Data using Tab delimiter
URL=$(echo "$SELECTED" | awk -F'\t' '{print $5}')
TITLE=$(echo "$SELECTED" | awk -F'\t' '{print $2}' | xargs)
TYPE=$(echo "$SELECTED" | awk -F'\t' '{print $1}' | xargs)

echo "ðŸš€ Downloading: $TITLE"

# Smart Download Logic
if [[ "$TYPE" == *"playlist"* ]]; then
    # Create a subfolder for the course
    SAFE_DIR="$DL_DIR/${TITLE//[^a-zA-Z0-9_ -]/}"
    mkdir -p "$SAFE_DIR"
    cd "$SAFE_DIR"
    yt-dlp -f "bv*+ba/b" --merge-output-format mp4 --concurrent-fragments 4 "$URL"
else
    # Single video goes to root or general folder
    cd "$DL_DIR"
    yt-dlp -f "bv*+ba/b" --merge-output-format mp4 "$URL"
fi

# Auto-Backup Logic
cd "$HOME/batch_tech/learning"
git add .
git commit -m "Auto-save: Consumed $TITLE" > /dev/null 2>&1
echo "âœ… Done & Backed up."
