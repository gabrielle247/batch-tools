#!/bin/bash

# MODE defaults to "chill" if not set
MODE="${BATCH_MODE:-chill}"
BASE_DIR="$HOME/batch_tech/$MODE"
DB="$BASE_DIR/db/index.db"
DL_DIR="$BASE_DIR/downloads"

# Initialize DB
sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS content (id TEXT PRIMARY KEY, title TEXT, channel TEXT, duration TEXT, url TEXT, type TEXT, platform TEXT);"

# Input Handling
INPUT="$1"

# Function: Is this a URL or a Search?
if [[ "$INPUT" =~ ^https?:// ]]; then
    # === URL MODE ===
    echo "ðŸ”— URL detected. Fetching metadata..."
    
    # We use jq with fallbacks (//) so it doesn't crash on missing data (like TikTok images having no duration)
    yt-dlp "$INPUT" --dump-json --skip-download --flat-playlist 2>/dev/null | \
    jq -r '[
        .id, 
        (.title // "Unknown Title"), 
        (.uploader // "Unknown Channel"), 
        (.duration_string // .duration // "0:00"), 
        .webpage_url, 
        (._type // "video"), 
        (.extractor // "generic")
    ] | @tsv' | \
    while IFS=$'\t' read -r id title channel dur url type platform; do
        safe_title=$(echo "$title" | tr -d '\t' | sed "s/'/''/g")
        sqlite3 "$DB" "INSERT OR IGNORE INTO content VALUES ('$id', '$safe_title', '$channel', '$dur', '$url', '$type', '$platform');"
    done

elif [ ! -z "$INPUT" ]; then
    # === SEARCH MODE (YouTube Only) ===
    echo "ðŸ” Searching YouTube for: $INPUT..."
    yt-dlp "ytsearch20:$INPUT" --dump-json --skip-download --flat-playlist 2>/dev/null | \
    jq -r '[.id, .title, .uploader, .duration_string, .webpage_url, ._type, "youtube"] | @tsv' | \
    while IFS=$'\t' read -r id title channel dur url type platform; do
        safe_title=$(echo "$title" | tr -d '\t' | sed "s/'/''/g")
        sqlite3 "$DB" "INSERT OR IGNORE INTO content VALUES ('$id', '$safe_title', '$channel', '$dur', '$url', '$type', '$platform');"
    done
fi

# Selector Interface
SELECTED=$(sqlite3 "$DB" -separator $'\t' "SELECT platform, title, channel, duration, url, type FROM content ORDER BY rowid DESC;" | \
fzf --delimiter=$'\t' --with-nth=1,2,3,4 --prompt="[$MODE] Select Content > " --border --height=50% --layout=reverse)

[ -z "$SELECTED" ] && exit 0

# Extract Selection
PLATFORM=$(echo "$SELECTED" | awk -F'\t' '{print $1}')
TITLE=$(echo "$SELECTED" | awk -F'\t' '{print $2}' | xargs)
URL=$(echo "$SELECTED" | awk -F'\t' '{print $5}')
TYPE=$(echo "$SELECTED" | awk -F'\t' '{print $6}')

echo "ðŸš€ Downloading ($PLATFORM): $TITLE"

# === DOWNLOAD LOGIC ===

# 1. Create Safe Title for Folder Names
SAFE_TITLE="${TITLE//[^a-zA-Z0-9_ -]/}"
[ -z "$SAFE_TITLE" ] && SAFE_TITLE="Untitled_Content"

# 2. TikTok Specific Handling (Images/Slideshows)
if [[ "$PLATFORM" == *"tiktok"* ]]; then
    # Always create a subfolder for TikToks because they often split into multiple image files
    TARGET_DIR="$DL_DIR/$SAFE_TITLE"
    mkdir -p "$TARGET_DIR"
    cd "$TARGET_DIR"
    echo "ðŸ“¸ Fetching TikTok content into: $TARGET_DIR"
    # We do NOT force MP4 here, allowing it to download images/audio naturally
    yt-dlp "$URL"

# 3. Playlists (Courses)
elif [[ "$TYPE" == *"playlist"* ]]; then
    TARGET_DIR="$DL_DIR/$SAFE_TITLE"
    mkdir -p "$TARGET_DIR"
    cd "$TARGET_DIR"
    yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best" --merge-output-format mp4 "$URL"

# 4. Standard Single Video
else
    cd "$DL_DIR"
    yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best" --merge-output-format mp4 "$URL"
fi

# Auto-Backup
cd "$BASE_DIR"
if [ ! -d .git ]; then git init; git config user.name "Sloth"; git config user.email "sloth@batch.tech"; fi
git add .
git commit -m "Auto-save ($MODE): $TITLE" > /dev/null 2>&1
echo "âœ… Done."
