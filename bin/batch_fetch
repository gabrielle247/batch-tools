#!/bin/bash

# === GREYWAY THEME & CONFIG ===
MODE="${BATCH_MODE:-chill}"
BASE_DIR="$HOME/batch_tech/$MODE"
DB="$BASE_DIR/db/index.db"
DL_DIR="$BASE_DIR/downloads"
LOG_DIR="$HOME/batch_tech/logs"
mkdir -p "$LOG_DIR" "$DL_DIR"

# Ensure DB exists
sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS content (id TEXT PRIMARY KEY, title TEXT, channel TEXT, duration TEXT, url TEXT, type TEXT, platform TEXT);"

# === INPUT HANDLING ===
INPUT="$1"

# === BACKGROUND WORKER DEFINITION ===
do_download() {
    local url="$1"
    local title="$2"
    local dir="$3"
    local log="$4"
    local mode="$5"
    
    mkdir -p "$dir"
    cd "$dir"
    echo "Starting download for: $title" > "$log"

    # QUALITY SETTING: Medium (Limit to 1080p)
    local Q_FMT="bv*[height<=1080]+ba/b[height<=1080] / best"

    if [[ "$url" == *"tiktok"* ]]; then
        # TikTok Logic (Series/Collections support)
        safe_t="${title//[^a-zA-Z0-9_ -]/}"
        mkdir -p "$safe_t" && cd "$safe_t"
        yt-dlp --yes-playlist -o "%(upload_date)s_%(title)s.%(ext)s" "$url" >> "$log" 2>&1

    elif [[ "$mode" == *"playlist"* ]]; then
        # Playlist Logic
        safe_t="${title//[^a-zA-Z0-9_ -]/}"
        mkdir -p "$safe_t" && cd "$safe_t"
        yt-dlp -f "$Q_FMT" --merge-output-format mp4 -o "%(playlist_index)s_%(title)s.%(ext)s" "$url" >> "$log" 2>&1
    else
        # Single Video
        yt-dlp -f "$Q_FMT" --merge-output-format mp4 "$url" >> "$log" 2>&1
    fi
}
export -f do_download

# === LOGIC FORK ===

if [[ "$INPUT" =~ ^https?:// ]]; then
    # === DIRECT URL MODE (NO MENU) ===
    echo -e "\033[1;34mðŸ”— URL Detected. Launching background download...\033[0m"
    
    # We define variables for the download
    URL="$INPUT"
    # We try to get a title quickly, but if it fails, we use a generic timestamp title so download isn't blocked
    TITLE=$(yt-dlp --get-title "$URL" 2>/dev/null || echo "Download_$(date +%s)")
    TYPE="video" # Default assumption
    
    # Also save to DB for history (Silent background update)
    (
        yt-dlp "$URL" --dump-json --skip-download --flat-playlist 2>/dev/null | \
        jq -r '[.id, (.title // "Unknown"), (.uploader // "Unknown"), (.duration_string // .duration // "0:00"), .webpage_url, (._type // "video"), (.extractor // "generic")] | @tsv' | \
        while IFS=$'\t' read -r id title channel dur url type platform; do
            safe_title=$(echo "$title" | tr -d '\t' | sed "s/'/''/g")
            sqlite3 "$DB" "INSERT OR IGNORE INTO content VALUES ('$id', '$safe_title', '$channel', '$dur', '$url', '$type', '$platform');"
        done
    ) &

    # Launch Download Immediately
    LOG_FILE="$LOG_DIR/$(date +%s)_download.log"
    nohup bash -c "do_download \"$URL\" \"$TITLE\" \"$DL_DIR\" \"$LOG_FILE\" \"$TYPE\"" >/dev/null 2>&1 &
    
    echo -e "âœ… \033[1;32mQueued:\033[0m $TITLE"
    echo -e "   Check progress with 'tasks'"
    exit 0

elif [ ! -z "$INPUT" ]; then
    # === SEARCH MODE (SHOW MENU) ===
    echo -e "\033[1;34mðŸ” Searching grid...\033[0m"
    yt-dlp "ytsearch20:$INPUT" --dump-json --skip-download --flat-playlist 2>/dev/null | \
    jq -r '[.id, .title, .uploader, .duration_string, .webpage_url, ._type, "youtube"] | @tsv' | \
    while IFS=$'\t' read -r id title channel dur url type platform; do
        safe_title=$(echo "$title" | tr -d '\t' | sed "s/'/''/g")
        sqlite3 "$DB" "INSERT OR IGNORE INTO content VALUES ('$id', '$safe_title', '$channel', '$dur', '$url', '$type', '$platform');"
    done
fi

# === THE MENU (Only runs if NOT a direct URL) ===
ACTIVE_TASKS=$(pgrep -f "yt-dlp" | wc -l)
export DB
export MODE

SELECTED=$(sqlite3 "$DB" -separator $'\t' "SELECT platform, title, channel, duration, url, type FROM content ORDER BY rowid DESC;" | \
fzf --delimiter=$'\t' --with-nth=2 \
    --layout=reverse \
    --border=rounded \
    --margin=1 \
    --padding=1 \
    --prompt="ðŸš€ $MODE > " \
    --pointer="â–¶" \
    --header="âš¡ Batch Tech v3.2 | Active Downloads: $ACTIVE_TASKS | ESC to Exit" \
    --preview-window="right:40%:wrap" \
    --preview '
        echo -e "\033[1;34mTitle:\033[0m   {2}"
        echo -e "\033[1;34mChannel:\033[0m {3}"
        echo -e "\033[1;30mURL:\033[0m     {5}"
    '
)

[ -z "$SELECTED" ] && exit 0

# Parse Selection
TITLE=$(echo "$SELECTED" | awk -F'\t' '{print $2}' | xargs)
URL=$(echo "$SELECTED" | awk -F'\t' '{print $5}')
TYPE=$(echo "$SELECTED" | awk -F'\t' '{print $6}')

# Launch Download
LOG_FILE="$LOG_DIR/$(date +%s)_download.log"
nohup bash -c "do_download \"$URL\" \"$TITLE\" \"$DL_DIR\" \"$LOG_FILE\" \"$TYPE\"" >/dev/null 2>&1 &

echo -e "\nâœ… \033[1;34mQueued in Background:\033[0m $TITLE"
